services:
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    command: start-dev
    ports:
      - 8080:8080
    networks:
      - solution_net
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=admin
      - KC_BOOTSTRAP_ADMIN_PASSWORD=admin

  broker:
    image: apache/kafka-native:latest
    ports:
      - 9092:9092
    networks:
      - solution_net
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://broker:9092,CONTROLLER://broker:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker:9092
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@broker:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_NUM_PARTITIONS=1

  auth_api:
    build:
      context: .
      dockerfile: auth/Dockerfile
    ports:
      - 4310:4310
    networks:
      - solution_net
    depends_on:
      - keycloak
      - broker
    environment:
      - KEYCLOAK_HOST=http://keycloak:8080
      - KEYCLOAK_ADMIN_LOGIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KEYCLOAK_CLIENT=app_client
      - KEYCLOAK_CLIENT_SECRET=secret_key_or_whatever
      - KEYCLOAK_REALM=demo_realm
      - KEYCLOAK_CUSTOMER_ROLE=customer
      - KEYCLOAK_VENDOR_ROLE=vendor
      - SERVICE_HOST=0.0.0.0:4310
      - KAFKA_HOST=broker:9092
      - KAFKA_CUSTOMER_TOPIC=customer-created
      - KAFKA_VENDOR_TOPIC=vendor-created

networks:
  solution_net:
    driver: bridge